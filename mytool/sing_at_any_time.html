<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTV æ•ˆæœéº¦å…‹é£</title>
    <style>
        /* CSS æ ·å¼ (æš—é»‘è‰²ä¸»é¢˜) */
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #121212;
            color: #ffffff;
            overflow: hidden;
        }

        h2 {
            color: #ffffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        #status {
            margin-bottom: 20px;
            font-size: 1.2em;
            color: #00ffff;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.7);
        }

        /* æ•ˆæœæ§åˆ¶é¢æ¿æ ·å¼ */
        #controls {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background-color: #1e1e1e;
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.1);
        }

        .control-group {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        label {
            min-width: 120px;
            font-weight: bold;
            color: #cccccc;
        }

        input[type="range"] {
            width: 150px;
            background: #333;
            border-radius: 5px;
        }

        input[type="range"]::-webkit-slider-thumb {
            width: 15px;
            height: 15px;
            background: #00ffff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: #00ffff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        span.value {
            min-width: 50px;
            text-align: right;
            font-weight: bold;
            color: #00ffff;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 5px;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(26, 115, 232, 0.3);
        }

        button:hover {
            background-color: #1557b0;
            box-shadow: 0 0 15px rgba(26, 115, 232, 0.5);
        }

        /* éŸ³é‡æ¡æ ·å¼ */
        #volumeMeter {
            margin-top: 30px;
            width: 300px;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        #volumeBar {
            height: 100%;
            background: linear-gradient(90deg, #00ffff, #1a73e8);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
        }

        /* èƒŒæ™¯åŠ¨æ€æ•ˆæœ */
        #backgroundEffect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at center, #1e3c72, #2a5298, #121212);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body>

    <!-- èƒŒæ™¯åŠ¨æ€æ•ˆæœ -->
    <div id="backgroundEffect"></div>

    <h2>ğŸ¤ KTV æ•ˆæœéº¦å…‹é£æ¨¡æ‹Ÿ</h2>
    <div id="status">ç‚¹å‡»â€œå¼€å§‹â€æŒ‰é’®ä»¥è¯·æ±‚éº¦å…‹é£æƒé™...</div>

    <button id="startButton">å¼€å§‹ KTV æ··éŸ³</button>

    <!-- éŸ³é‡æ¡ -->
    <div id="volumeMeter" style="display:none;">
        <div id="volumeBar"></div>
    </div>

    <div id="controls" style="display:none;">
        <h3>éŸ³é¢‘æ•ˆæœæ§åˆ¶</h3>

        <div class="control-group">
            <label for="micGain">éº¦å…‹é£éŸ³é‡:</label>
            <input type="range" id="micGain" min="0" max="2.0" step="0.01" value="1.0">
            <span id="micGainValue" class="value">1.00</span>
        </div>
        
        <!-- EQå‡è¡¡å™¨ -->
        <h3>EQå‡è¡¡å™¨</h3>
        <div class="control-group">
            <label for="eqLow">ä½é¢‘ (60-200Hz):</label>
            <input type="range" id="eqLow" min="-12" max="12" step="0.5" value="0">
            <span id="eqLowValue" class="value">0.0 dB</span>
        </div>
        <div class="control-group">
            <label for="eqMid">ä¸­é¢‘ (200Hz-3kHz):</label>
            <input type="range" id="eqMid" min="-12" max="12" step="0.5" value="0">
            <span id="eqMidValue" class="value">0.0 dB</span>
        </div>
        <div class="control-group">
            <label for="eqHigh">é«˜é¢‘ (3kHz-10kHz):</label>
            <input type="range" id="eqHigh" min="-12" max="12" step="0.5" value="0">
            <span id="eqHighValue" class="value">0.0 dB</span>
        </div>
        
        <!-- æ··å“æ•ˆæœ -->
        <h3>æ··å“æ•ˆæœ</h3>
        <div class="control-group">
            <label for="reverbTime">æ··å“æ—¶é—´ (ç§’):</label>
            <input type="range" id="reverbTime" min="0.1" max="3.0" step="0.1" value="1.0">
            <span id="reverbTimeValue" class="value">1.00</span>
        </div>
        <div class="control-group">
            <label for="delayTime">å»¶è¿Ÿæ—¶é—´ (ç§’):</label>
            <input type="range" id="delayTime" min="0.05" max="0.5" step="0.01" value="0.1">
            <span id="delayTimeValue" class="value">0.10</span>
        </div>
        <div class="control-group">
            <label for="reverbMix">å¹²æ¹¿æ¯”:</label>
            <input type="range" id="reverbMix" min="0" max="1.0" step="0.01" value="0.3">
            <span id="reverbMixValue" class="value">0.30</span>
        </div>
        
        <!-- ä¸€é”®æ¢å¤é»˜è®¤è®¾ç½®æŒ‰é’® -->
        <button id="resetButton">ä¸€é”®æ¢å¤é»˜è®¤è®¾ç½®</button>

    </div>

    <script>
        // JavaScript é€»è¾‘
        const statusDiv = document.getElementById('status');
        const startButton = document.getElementById('startButton');
        const controlsDiv = document.getElementById('controls');
        const volumeMeter = document.getElementById('volumeMeter');
        const volumeBar = document.getElementById('volumeBar');

        // æ§åˆ¶å™¨å…ƒç´ 
        const micGainInput = document.getElementById('micGain');
        
        // EQæ§åˆ¶å™¨å…ƒç´ 
        const eqLowInput = document.getElementById('eqLow');
        const eqMidInput = document.getElementById('eqMid');
        const eqHighInput = document.getElementById('eqHigh');
        
        // æ··å“å’Œå»¶è¿Ÿæ§åˆ¶å™¨å…ƒç´ 
        const reverbTimeInput = document.getElementById('reverbTime');
        const delayTimeInput = document.getElementById('delayTime');
        const reverbMixInput = document.getElementById('reverbMix');
        
        // æ˜¾ç¤ºå…ƒç´ 
        const micGainValueSpan = document.getElementById('micGainValue');
        const eqLowValueSpan = document.getElementById('eqLowValue');
        const eqMidValueSpan = document.getElementById('eqMidValue');
        const eqHighValueSpan = document.getElementById('eqHighValue');
        const reverbTimeValueSpan = document.getElementById('reverbTimeValue');
        const delayTimeValueSpan = document.getElementById('delayTimeValue');
        const reverbMixValueSpan = document.getElementById('reverbMixValue');
        
        // æ¢å¤é»˜è®¤è®¾ç½®æŒ‰é’®
        const resetButton = document.getElementById('resetButton');

        let audioContext;
        let stream;
        let micSource;         // éº¦å…‹é£è¾“å…¥æº
        let micGainNode;       // éº¦å…‹é£éŸ³é‡æ§åˆ¶
        let analyserNode;      // åˆ†æèŠ‚ç‚¹ (ç”¨äºéŸ³é‡ç›‘æµ‹)
        let dataArray;         // å­˜å‚¨éŸ³é¢‘æ•°æ®çš„æ•°ç»„
        let animationId;       // åŠ¨ç”»å¸§ID
        
        // EQèŠ‚ç‚¹
        let eqLowNode;         // ä½é¢‘å‡è¡¡å™¨èŠ‚ç‚¹
        let eqMidNode;         // ä¸­é¢‘å‡è¡¡å™¨èŠ‚ç‚¹
        let eqHighNode;        // é«˜é¢‘å‡è¡¡å™¨èŠ‚ç‚¹
        
        // æ··å“èŠ‚ç‚¹
        let reverbNode;        // æ··å“æ•ˆæœèŠ‚ç‚¹
        let delayNode;         // å»¶è¿ŸèŠ‚ç‚¹ (ç”¨äºæ··å“ä¸­çš„å»¶è¿Ÿæ•ˆæœ)
        let dryGainNode;       // å¹²ä¿¡å·å¢ç›ŠèŠ‚ç‚¹
        let wetGainNode;       // æ¹¿ä¿¡å·å¢ç›ŠèŠ‚ç‚¹
        
        /**
         * @function setupAudioNodes
         * è®¾ç½®Web Audio APIçš„èŠ‚ç‚¹å’Œæ•ˆæœé“¾
         * é“¾æ¡: éº¦å…‹é£ -> å¢ç›Š (éŸ³é‡) -> åˆ†æå™¨ -> (æ··å“/å»¶è¿Ÿ) -> æ‰¬å£°å™¨ (Destination)
         */
        function setupAudioNodes() {
            // 1. åˆ›å»º AudioContext
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // 2. åˆ›å»ºéº¦å…‹é£æºèŠ‚ç‚¹
            micSource = audioContext.createMediaStreamSource(stream);

            // 3. åˆ›å»ºå¢ç›ŠèŠ‚ç‚¹ (æ§åˆ¶éº¦å…‹é£éŸ³é‡)
            micGainNode = audioContext.createGain();
            micGainNode.gain.setValueAtTime(parseFloat(micGainInput.value), audioContext.currentTime);

            // 4. åˆ›å»ºåˆ†æèŠ‚ç‚¹ (ç”¨äºéŸ³é‡ç›‘æµ‹)
            analyserNode = audioContext.createAnalyser();
            analyserNode.fftSize = 256; // è®¾ç½®FFTå¤§å°
            const bufferLength = analyserNode.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength); // å­˜å‚¨éŸ³é¢‘æ•°æ®

            // 5. åˆ›å»ºEQå‡è¡¡å™¨èŠ‚ç‚¹
            eqLowNode = audioContext.createBiquadFilter();
            eqLowNode.type = 'lowshelf'; // ä½é¢‘æ¶å¼æ»¤æ³¢å™¨
            eqLowNode.frequency.setValueAtTime(100, audioContext.currentTime); // ä¸­å¿ƒé¢‘ç‡
            eqLowNode.gain.setValueAtTime(parseFloat(eqLowInput.value), audioContext.currentTime); // å¢ç›Š
            
            eqMidNode = audioContext.createBiquadFilter();
            eqMidNode.type = 'peaking'; // å³°å€¼æ»¤æ³¢å™¨
            eqMidNode.frequency.setValueAtTime(1000, audioContext.currentTime); // ä¸­å¿ƒé¢‘ç‡
            eqMidNode.Q.setValueAtTime(1, audioContext.currentTime); // å“è´¨å› æ•°
            eqMidNode.gain.setValueAtTime(parseFloat(eqMidInput.value), audioContext.currentTime); // å¢ç›Š
            
            eqHighNode = audioContext.createBiquadFilter();
            eqHighNode.type = 'highshelf'; // é«˜é¢‘æ¶å¼æ»¤æ³¢å™¨
            eqHighNode.frequency.setValueAtTime(4000, audioContext.currentTime); // ä¸­å¿ƒé¢‘ç‡
            eqHighNode.gain.setValueAtTime(parseFloat(eqHighInput.value), audioContext.currentTime); // å¢ç›Š

            // 6. åˆ›å»ºæ··å“æ•ˆæœèŠ‚ç‚¹
            dryGainNode = audioContext.createGain();
            wetGainNode = audioContext.createGain();
            
            // ä½¿ç”¨åé¦ˆå»¶è¿Ÿç½‘ç»œå®ç°æ··å“æ•ˆæœ
            const reverbTime = parseFloat(reverbTimeInput.value);
            const reverbMix = parseFloat(reverbMixInput.value);
            
            // è®¾ç½®å¹²æ¹¿æ¯”
            dryGainNode.gain.setValueAtTime(1 - reverbMix, audioContext.currentTime);
            wetGainNode.gain.setValueAtTime(reverbMix, audioContext.currentTime);
            
            // åˆ›å»ºæ··å“ç½‘ç»œ
            const reverbDelay1 = audioContext.createDelay(1.0);
            const reverbDelay2 = audioContext.createDelay(1.0);
            const reverbDelay3 = audioContext.createDelay(1.0);
            const reverbDelay4 = audioContext.createDelay(1.0);
            
            const reverbGain1 = audioContext.createGain();
            const reverbGain2 = audioContext.createGain();
            const reverbGain3 = audioContext.createGain();
            const reverbGain4 = audioContext.createGain();
            
            // è®¾ç½®å»¶è¿Ÿæ—¶é—´ï¼ˆåŸºäºæ··å“æ—¶é—´è®¡ç®—ï¼‰
            reverbDelay1.delayTime.setValueAtTime(0.0117, audioContext.currentTime);
            reverbDelay2.delayTime.setValueAtTime(0.0103, audioContext.currentTime);
            reverbDelay3.delayTime.setValueAtTime(0.0077, audioContext.currentTime);
            reverbDelay4.delayTime.setValueAtTime(0.0059, audioContext.currentTime);
            
            // è®¾ç½®è¡°å‡ï¼ˆåŸºäºæ··å“æ—¶é—´ï¼‰
            const decayFactor = Math.pow(0.001, (1.0 / reverbTime));
            reverbGain1.gain.setValueAtTime(decayFactor, audioContext.currentTime);
            reverbGain2.gain.setValueAtTime(decayFactor, audioContext.currentTime);
            reverbGain3.gain.setValueAtTime(decayFactor, audioContext.currentTime);
            reverbGain4.gain.setValueAtTime(decayFactor, audioContext.currentTime);
            
            // è¿æ¥æ··å“ç½‘ç»œ
            reverbDelay1.connect(reverbGain1);
            reverbGain1.connect(reverbDelay2);
            reverbGain1.connect(wetGainNode);
            
            reverbDelay2.connect(reverbGain2);
            reverbGain2.connect(reverbDelay3);
            reverbGain2.connect(wetGainNode);
            
            reverbDelay3.connect(reverbGain3);
            reverbGain3.connect(reverbDelay4);
            reverbGain3.connect(wetGainNode);
            
            reverbDelay4.connect(reverbGain4);
            reverbGain4.connect(reverbDelay1);
            reverbGain4.connect(wetGainNode);
            
            // å°†æ··å“ç½‘ç»œå­˜å‚¨åœ¨å˜é‡ä¸­ä»¥ä¾¿åç»­æ§åˆ¶
            reverbNode = {
                delay1: reverbDelay1,
                delay2: reverbDelay2,
                delay3: reverbDelay3,
                delay4: reverbDelay4,
                gain1: reverbGain1,
                gain2: reverbGain2,
                gain3: reverbGain3,
                gain4: reverbGain4
            };
            
            // 7. è¿æ¥éŸ³é¢‘å¤„ç†é“¾ (æ•´åˆEQå’Œæ··å“)
            // éº¦å…‹é£è¾“å…¥ -> å¢ç›Š -> EQ(ä½->ä¸­->é«˜) -> åˆ†æå™¨ -> å¹²æ¹¿åˆ†æ”¯
            // å¹²ä¿¡å·: -> dryGain -> æ‰¬å£°å™¨
            // æ¹¿ä¿¡å·: -> æ··å“ -> wetGain -> æ‰¬å£°å™¨

            // ä¸»ä¿¡å·é“¾ï¼šéº¦å…‹é£ -> å¢ç›Š -> EQ -> åˆ†æå™¨
            micSource.connect(micGainNode);
            micGainNode.connect(eqLowNode);
            eqLowNode.connect(eqMidNode);
            eqMidNode.connect(eqHighNode);
            eqHighNode.connect(analyserNode);
            
            // åˆ›å»ºå»¶è¿ŸèŠ‚ç‚¹
            delayNode = audioContext.createDelay(1.0);
            delayNode.delayTime.setValueAtTime(parseFloat(delayTimeInput.value), audioContext.currentTime);
            
            // å¹²æ¹¿åˆ†æ”¯
            analyserNode.connect(dryGainNode);
            analyserNode.connect(delayNode); // å…ˆç»è¿‡å»¶è¿Ÿ
            delayNode.connect(reverbNode.delay1); // å»¶è¿Ÿåçš„ä¿¡å·é€å…¥æ··å“ç½‘ç»œ
            
            // è¾“å‡ºåˆ°æ‰¬å£°å™¨
            dryGainNode.connect(audioContext.destination);
            wetGainNode.connect(audioContext.destination);

            statusDiv.textContent = 'âœ… éº¦å…‹é£å·²è¿æ¥ï¼ŒKTV æ•ˆæœå·²æ¿€æ´»ï¼';
            
            // å¼€å§‹éŸ³é‡ç›‘æµ‹
            startVolumeMonitoring();
        }

        /**
         * @function startMicrophone
         * å¯åŠ¨éº¦å…‹é£å¹¶è®¾ç½®Web Audio API
         */
        async function startMicrophone() {
            try {
                // è¯·æ±‚éº¦å…‹é£æƒé™å’Œæ‰¬å£°å™¨è¾“å‡º
                stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false, // ç¦ç”¨å›éŸ³æ¶ˆé™¤ï¼Œä»¥è·å¾—æ›´å¥½çš„KTVæ•ˆæœ
                        noiseSuppression: false
                    } 
                });
                
                setupAudioNodes();
                setupControls();

                startButton.textContent = 'åœæ­¢ KTV æ··éŸ³';
            startButton.onclick = stopMicrophone;
            controlsDiv.style.display = 'block';
            volumeMeter.style.display = 'block';

            } catch (err) {
                console.error('è·å–éº¦å…‹é£å¤±è´¥:', err);
                statusDiv.textContent = `âŒ é”™è¯¯: æ— æ³•è·å–éº¦å…‹é£æƒé™æˆ–è®¾å¤‡ã€‚è¯·æ£€æŸ¥è®¾ç½®ã€‚(${err.name})`;
                startButton.textContent = 'é‡æ–°å¼€å§‹';
                controlsDiv.style.display = 'none';
            }
        }
        
        /**
         * @function setupControls
         * è®¾ç½®æ»‘å—æ§åˆ¶å™¨çš„äº‹ä»¶ç›‘å¬
         */
        function setupControls() {
            // éº¦å…‹é£éŸ³é‡æ§åˆ¶
            micGainInput.oninput = () => {
                const val = parseFloat(micGainInput.value);
                micGainNode.gain.setValueAtTime(val, audioContext.currentTime);
                micGainValueSpan.textContent = val.toFixed(2);
            };

            // EQä½é¢‘æ§åˆ¶
            eqLowInput.oninput = () => {
                const val = parseFloat(eqLowInput.value);
                eqLowNode.gain.setValueAtTime(val, audioContext.currentTime);
                eqLowValueSpan.textContent = val.toFixed(1) + ' dB';
            };

            // EQä¸­é¢‘æ§åˆ¶
            eqMidInput.oninput = () => {
                const val = parseFloat(eqMidInput.value);
                eqMidNode.gain.setValueAtTime(val, audioContext.currentTime);
                eqMidValueSpan.textContent = val.toFixed(1) + ' dB';
            };

            // EQé«˜é¢‘æ§åˆ¶
            eqHighInput.oninput = () => {
                const val = parseFloat(eqHighInput.value);
                eqHighNode.gain.setValueAtTime(val, audioContext.currentTime);
                eqHighValueSpan.textContent = val.toFixed(1) + ' dB';
            };

            // æ··å“æ—¶é—´æ§åˆ¶
            reverbTimeInput.oninput = () => {
                const val = parseFloat(reverbTimeInput.value);
                reverbTimeValueSpan.textContent = val.toFixed(2);
                
                // æ›´æ–°æ··å“ç½‘ç»œçš„è¡°å‡å› å­
                const decayFactor = Math.pow(0.001, (1.0 / val));
                reverbNode.gain1.gain.setValueAtTime(decayFactor, audioContext.currentTime);
                reverbNode.gain2.gain.setValueAtTime(decayFactor, audioContext.currentTime);
                reverbNode.gain3.gain.setValueAtTime(decayFactor, audioContext.currentTime);
                reverbNode.gain4.gain.setValueAtTime(decayFactor, audioContext.currentTime);
            };
            
            // å»¶è¿Ÿæ—¶é—´æ§åˆ¶
            delayTimeInput.oninput = () => {
                const val = parseFloat(delayTimeInput.value);
                delayNode.delayTime.setValueAtTime(val, audioContext.currentTime);
                delayTimeValueSpan.textContent = val.toFixed(2);
            };

            // å¹²æ¹¿æ¯”æ§åˆ¶
            reverbMixInput.oninput = () => {
                const val = parseFloat(reverbMixInput.value);
                reverbMixValueSpan.textContent = val.toFixed(2);
                
                // æ›´æ–°å¹²æ¹¿ä¿¡å·å¢ç›Š
                dryGainNode.gain.setValueAtTime(1 - val, audioContext.currentTime);
                wetGainNode.gain.setValueAtTime(val, audioContext.currentTime);
            };
        }


        /**
         * @function stopMicrophone
         * åœæ­¢éº¦å…‹é£è¾“å…¥å¹¶æ¸…ç†èµ„æº
         */
        function stopMicrophone() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            // åœæ­¢éŸ³é‡ç›‘æµ‹åŠ¨ç”»
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            statusDiv.textContent = 'â¸ï¸ ç›‘æ§å·²åœæ­¢ã€‚ç‚¹å‡»â€œå¼€å§‹â€é‡æ–°å¯åŠ¨ã€‚';
            startButton.textContent = 'å¼€å§‹ KTV æ··éŸ³';
            startButton.onclick = startMicrophone;
            controlsDiv.style.display = 'none';
            volumeMeter.style.display = 'none';
            volumeBar.style.width = '0%';
        }

        /**
         * @function startVolumeMonitoring
         * å¼€å§‹å®æ—¶ç›‘æµ‹éŸ³é‡å¹¶æ›´æ–°UI
         */
        function startVolumeMonitoring() {
            if (!analyserNode) return;
            
            // è·å–éŸ³é¢‘æ•°æ®å¹¶æ›´æ–°éŸ³é‡æ¡
            function updateVolumeBar() {
                analyserNode.getByteFrequencyData(dataArray);
                
                // è®¡ç®—å¹³å‡éŸ³é‡
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    sum += dataArray[i];
                }
                const average = sum / dataArray.length;
                
                // å°†éŸ³é‡è½¬æ¢ä¸ºç™¾åˆ†æ¯” (0-100%)
                const volumePercent = Math.min((average / 255) * 100, 100);
                
                // æ›´æ–°éŸ³é‡æ¡å®½åº¦
                volumeBar.style.width = volumePercent + '%';
                
                // ç»§ç»­ä¸‹ä¸€å¸§
                animationId = requestAnimationFrame(updateVolumeBar);
            }
            
            updateVolumeBar();
        }

        /**
         * @function resetToDefaults
         * ä¸€é”®æ¢å¤æ‰€æœ‰è®¾ç½®åˆ°é»˜è®¤å€¼
         */
        function resetToDefaults() {
            // é»˜è®¤å€¼å®šä¹‰
            const defaults = {
                micGain: 1.0,
                eqLow: 0.0,
                eqMid: 0.0,
                eqHigh: 0.0,
                reverbTime: 1.0,
                delayTime: 0.1,
                reverbMix: 0.3
            };
            
            // é‡ç½®UIæ§ä»¶å€¼
            micGainInput.value = defaults.micGain;
            eqLowInput.value = defaults.eqLow;
            eqMidInput.value = defaults.eqMid;
            eqHighInput.value = defaults.eqHigh;
            reverbTimeInput.value = defaults.reverbTime;
            delayTimeInput.value = defaults.delayTime;
            reverbMixInput.value = defaults.reverbMix;
            
            // æ›´æ–°æ˜¾ç¤ºå€¼
            micGainValueSpan.textContent = defaults.micGain.toFixed(2);
            eqLowValueSpan.textContent = defaults.eqLow.toFixed(1) + ' dB';
            eqMidValueSpan.textContent = defaults.eqMid.toFixed(1) + ' dB';
            eqHighValueSpan.textContent = defaults.eqHigh.toFixed(1) + ' dB';
            reverbTimeValueSpan.textContent = defaults.reverbTime.toFixed(2);
            delayTimeValueSpan.textContent = defaults.delayTime.toFixed(2);
            reverbMixValueSpan.textContent = defaults.reverbMix.toFixed(2);
            
            // å¦‚æœéŸ³é¢‘ä¸Šä¸‹æ–‡å·²åˆ›å»ºï¼Œæ›´æ–°éŸ³é¢‘èŠ‚ç‚¹å‚æ•°
            if (audioContext) {
                micGainNode.gain.setValueAtTime(defaults.micGain, audioContext.currentTime);
                eqLowNode.gain.setValueAtTime(defaults.eqLow, audioContext.currentTime);
                eqMidNode.gain.setValueAtTime(defaults.eqMid, audioContext.currentTime);
                eqHighNode.gain.setValueAtTime(defaults.eqHigh, audioContext.currentTime);
                delayNode.delayTime.setValueAtTime(defaults.delayTime, audioContext.currentTime);
                
                // æ›´æ–°æ··å“æ—¶é—´ï¼ˆè¡°å‡å› å­ï¼‰
                const decayFactor = Math.pow(0.001, (1.0 / defaults.reverbTime));
                reverbNode.gain1.gain.setValueAtTime(decayFactor, audioContext.currentTime);
                reverbNode.gain2.gain.setValueAtTime(decayFactor, audioContext.currentTime);
                reverbNode.gain3.gain.setValueAtTime(decayFactor, audioContext.currentTime);
                reverbNode.gain4.gain.setValueAtTime(decayFactor, audioContext.currentTime);
                
                // æ›´æ–°å¹²æ¹¿æ¯”
                dryGainNode.gain.setValueAtTime(1 - defaults.reverbMix, audioContext.currentTime);
                wetGainNode.gain.setValueAtTime(defaults.reverbMix, audioContext.currentTime);
            }
        }

        // åˆå§‹åŒ–ï¼šè®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        startButton.onclick = startMicrophone;
        resetButton.onclick = resetToDefaults;
        
    </script>
</body>
</html>